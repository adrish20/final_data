<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5G Network Failure Prediction</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="container">
        <h2>5G Network Failure Prediction</h2>

        <button onclick="predictFailure()">Predict Network Failure</button>
        <div id="network-details"></div>
        <div id="prediction-result"></div>
    </div>

    <script>
        let networkInfo = null;
        let lat = null;
        let lng = null;

        // Main function to handle permission, get network info, and predict failure
        async function predictFailure() {
            await getNetworkInfo();
            const avgDownloadSpeed = await measureNetworkSpeeds();

            // Estimate signal strength based on both latency and download speed
            const signalStrength = estimateSignalStrength(networkInfo.rtt, avgDownloadSpeed);

            // Display the updated network details with estimated signal strength
            document.getElementById('network-details').innerHTML += 
                `<br>Estimated Signal Strength: ${signalStrength}`;

            // Once network details are gathered, send the data for prediction
            await getPrediction(signalStrength);
        }

        // Get network info using Network Information API
        function getNetworkInfo() {
            return new Promise((resolve, reject) => {
                if ('connection' in navigator) {
                    networkInfo = navigator.connection || navigator.mozConnection || navigator.webkitConnection;

                    // Get user location (geolocation)
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            lat = position.coords.latitude;
                            lng = position.coords.longitude;
                            resolve();
                        }, reject);
                    } else {
                        alert('Geolocation API not supported');
                        resolve();
                    }
                } else {
                    alert('Network Information API not supported');
                    resolve();
                }
            });
        }

        // Function to measure download speeds over 5 seconds
        async function measureNetworkSpeeds() {
            let downloadSpeeds = [];

            const testUrl = 'https://example.com/small-test-file.txt';  // Test file URL

            const startTime = Date.now();
            while ((Date.now() - startTime) < 5000) {  // Measure for 5 seconds
                downloadSpeeds.push(await measureDownloadSpeed(testUrl));
            }

            const avgDownloadSpeed = (downloadSpeeds.reduce((a, b) => a + b, 0) / downloadSpeeds.length).toFixed(2);
            document.getElementById('network-details').innerHTML +=
                `<br>Average Download Speed: ${avgDownloadSpeed} Mbps`;

            return avgDownloadSpeed;
        }

        // Function to measure download speed
        async function measureDownloadSpeed(url) {
            const startTime = Date.now();
            const response = await fetch(url);  // Fetch the test file
            const data = await response.blob(); // Get the file size
            const fileSize = data.size * 8 / (1024 * 1024);  // Convert to Megabits
            const duration = (Date.now() - startTime) / 1000;  // Time in seconds

            // Download Speed in Mbps
            return (fileSize / duration).toFixed(2);
        }

        // Function to estimate signal strength based on RTT (latency) and download speed
        function estimateSignalStrength(rtt, downloadSpeed) {
            if (rtt <= 50 && downloadSpeed > 50) {
                return '-50 to -70 dBm (Excellent)';
            } else if (rtt <= 100 && downloadSpeed > 20) {
                return '-70 to -85 dBm (Good)';
            } else if (rtt <= 150 && downloadSpeed >10) {
                return '-85 to -95 dBm (Fair)';
            } else if (rtt >150 && downloadSpeed > 1) {
                return '-85 to -115 dBm (Poor)';
            } else {
                return 'Below -115 dBm (Very Poor)';
            }
        }

        // Send network data to the backend for prediction
        async function getPrediction(signalStrength) {
            const data = {
                network_type: networkInfo ? networkInfo.effectiveType : 'unknown',
                rtt: networkInfo ? networkInfo.rtt : 0,
                downlink: networkInfo ? networkInfo.downlink : 0,
                signal_strength: signalStrength,
                lat: lat,
                lng: lng
            };

            const response = await fetch('http://localhost:5000/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            document.getElementById('prediction-result').innerHTML = `Prediction: ${result.prediction}`;
        }
    </script>

</body>
</html>
